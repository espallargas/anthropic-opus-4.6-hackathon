#!/bin/bash
# Clean up stuck processes and PID files

set -e

echo "ğŸ§¹ Cleaning up stuck processes..."

# Kill all related processes
pkill -9 -f "bin/rails" 2>/dev/null || true
pkill -9 -f "bundle exec rails" 2>/dev/null || true
pkill -9 -f "puma" 2>/dev/null || true
pkill -9 -f "vite" 2>/dev/null || true
pkill -9 -f "node" 2>/dev/null || true
pkill -9 -f "foreman" 2>/dev/null || true

# Clean up PID files
rm -f backend/tmp/pids/server.pid
rm -f backend/tmp/pids/sidekiq.pid

# Wait a moment
sleep 1

# Verify ports are free
if lsof -i :3000,:5173 2>/dev/null | grep -v COMMAND; then
  echo "âŒ Ports still in use!"
  exit 1
else
  echo "âœ“ Portas 3000 e 5173 livres"
fi

echo "âœ“ Cleanup complete! Run 'bin/dev' to start"
