#!/bin/bash
# Clean up dev server processes (Foreman, Rails, Vite)
# Only kills processes started by bin/dev

echo "üßπ Cleaning up dev processes..."

# Kill Foreman first (which will cascade to its children)
pkill -f "foreman start" 2>/dev/null || true

# Wait a moment for graceful shutdown
sleep 1

# If Foreman didn't cleanup, manually kill Rails and Vite
pkill -9 -f "bin/rails server" 2>/dev/null || true
pkill -9 -f "bin/vite" 2>/dev/null || true

# Clean up PID files
rm -f backend/tmp/pids/server.pid

# Wait a moment
sleep 1

# Verify ports are free
if lsof -i :3000,:5173 2>/dev/null | grep -v COMMAND; then
  echo "‚ö†Ô∏è  Ports still in use, forcing cleanup..."
  pkill -9 -f "bin/rails" || true
  pkill -9 -f "vite" || true
  sleep 1
else
  echo "‚úì Ports 3000 and 5173 are free"
fi

echo "‚úì Cleanup complete! Run 'bin/dev' to start"
